<?xml version="1.0" encoding="utf-8"?>
<!--GoogleMaps plugin additions-->
<root xmlns:android="http://schemas.android.com/apk/res/android">
	<androidManifestUpdates>
		<addElements tag="application">
				<meta-data android:name="com.google.android.gms.version" 
					android:value="@integer/google_play_services_version" />
			<!--<meta-data android:name="com.google.android.geo.API_KEY"
					android:value="AIzaSyAIahxW93kRq42j2hnpK_5HBDXv4oufb8w"/>-->
			<meta-data android:name="com.google.android.geo.API_KEY"
					android:value="AIzaSyChN7lO4AdIZQR1hIItdThFjbqEjCwqT00"/>     

			<service
	            android:name="com.jeevcatgames.GPSService"
	            android:exported="false"
	            android:process=":remote"/>
		</addElements>

		<addElements tag="manifest">
			<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
			<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
		</addElements>	
	</androidManifestUpdates>
	<prebuildCopies>
		<copyDir src="$S(PluginDir)/Java" dst="$S(BuildDir)" />
	</prebuildCopies>
	<proguardAdditions>
    	<insert>
    		-keep class * extends java.util.ListResourceBundle {
			    protected Object[][] getContents();
			}

			-keep public class com.google.android.gms.common.internal.safeparcel.SafeParcelable {
			    public static final *** NULL;
			}

			-keepnames @com.google.android.gms.common.annotation.KeepName class *
			-keepclassmembernames class * {
			    @com.google.android.gms.common.annotation.KeepName *;
			}

			-keepnames class * implements android.os.Parcelable {
			    public static final ** CREATOR;
			}
	    </insert>
	</proguardAdditions>
	
	<gameActivityImportAdditions>
		<insert>
			import android.os.Bundle;
			import android.app.ActivityManager;
			
			import com.jeevcatgames.UEMapDialog;
			import com.jeevcatgames.GPSService;
		</insert>
	</gameActivityImportAdditions>
	<gameActivityOnStartAdditions>
		<insert>

		</insert>
	</gameActivityOnStartAdditions>
	<gameActivityOnCreateAdditions>
		<insert>
			Log.debug("new UEMapDialog");
			mMapDialog = new UEMapDialog(_activity);
		</insert>
	</gameActivityOnCreateAdditions>
		if(isServiceRunning()
	<gameActivityClassAdditions>
		<insert>
    		private static final int REQUEST_CHECK_SETTINGS = 0x1;
			private UEMapDialog mMapDialog;

			public void AndroidThunkJava_CreateGoogleMap(float posX, float posY, float sizeX, float sizeY, float renderX) {
		        Log.debug("In AndroidThunkJava_CreateGoogleMap");
		        DisplayMetrics dm = getResources().getDisplayMetrics();
		        float scale = dm.widthPixels / renderX;

		        mMapDialog.CreateGoogleMap(
		        	(int)(posX * scale), 
		        	(int) (posY * scale), 
		        	(int) (sizeX * scale), 
		        	(int) (sizeY * scale));

		    }

		    public void AndroidThunkJava_RemoveGoogleMap() {
		        Log.debug("In AndroidThunkJava_RemoveGoogleMap");
		        mMapDialog.RemoveGoogleMap();
		    }

		    public void AndroidThunkJava_ConnectGoogleAPI() {
		        Log.debug("In AndroidThunkJava_ConnectGoogleAPI");
		        mMapDialog.ConnectGoogleAPI();
		    }

		    public void AndroidThunkJava_DisconnectGoogleAPI() {
		        Log.debug("In AndroidThunkJava_DisconnectGoogleAPI");
		        mMapDialog.DisconnectGoogleAPI();
		    }

		    private boolean isServiceRunning(Class&lt;?&gt; serviceClass) {
			    ActivityManager manager = (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);
			    for (ActivityManager.RunningServiceInfo service : manager.getRunningServices(Integer.MAX_VALUE)) {
			        if (serviceClass.getName().equals(service.service.getClassName())) {
			            return true;
			        }
			    }
			    return false;
			}

		//public native void nativeLocationChanged(double lat, double lng);
			public native void nativeResumeTracking();
		</insert>
	</gameActivityClassAdditions>

	<gameActivityOnActivityResultAdditions>	
		<insert>
			if(requestCode == REQUEST_CHECK_SETTINGS){
				switch (resultCode) {
                    case RESULT_OK:
                        Log.debug("User agreed to make required location settings changes.");
                        mMapDialog.startLocationUpdates();
                        break;
                    case RESULT_CANCELED:
                        Log.debug("User chose not to make required location settings changes.");
                        break;
                }
			}
		</insert>
	</gameActivityOnActivityResultAdditions>
	<gameActivityOnPauseAdditions>
		<insert>
			mMapDialog.hide();
		</insert>
	</gameActivityOnPauseAdditions>
	<gameActivityOnResumeAdditions>
		<insert>
			mMapDialog.OnResume();
			if(isServiceRunning(GPSService.class)) {
				Log.debug("Service running! Should move to different screen");
				nativeResumeTracking();
			}
		</insert>
	</gameActivityOnResumeAdditions>
</root>